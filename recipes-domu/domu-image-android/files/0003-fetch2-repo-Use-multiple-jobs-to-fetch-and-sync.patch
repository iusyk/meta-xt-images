From 2c230f73f6892aa318f90f4c519280927a2120a7 Mon Sep 17 00:00:00 2001
From: Usyk Ihor <ihor_usyk@epam.com>
Date: Fri, 13 Dec 2019 15:29:13 +0100
Subject: [PATCH 3/4] fetch2/repo: Use multiple jobs to fetch and sync

Google repo supports "--jobs" parameter, so one can
speed up the process of fetching and syncing. According to
https://groups.google.com/a/chromium.org/forum/#!topic/chromium-os-dev/ny3nkgE9AE8
it is even more gets to speed if used separately for
network jobs and "local" ones.
Use BB_NUMBER_THREADS to run parallel repo sync.

Signed-off-by: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>
---
 bitbake/lib/bb/fetch2/repo.py | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/bitbake/lib/bb/fetch2/repo.py b/bitbake/lib/bb/fetch2/repo.py
index 704e84390f..2d9080c9d5 100644
--- a/bitbake/lib/bb/fetch2/repo.py
+++ b/bitbake/lib/bb/fetch2/repo.py
@@ -59,6 +59,12 @@ class Repo(FetchMethod):
         ud.codir = os.path.join(repodir, gitsrcname, ud.manifest)
         ud.repodir = os.path.join(ud.codir, "repo")
 
+    def sync(self, destdir, d):
+        # repo can separate the "network" sync (the git fetch part, network bound)
+        # from the "local" sync (the git rebase part, compute & i/o bound).
+        num_jobs = d.getVar("BB_NUMBER_THREADS", True) or "1"
+        runfetchcmd("repo sync -c -n -j%s" % num_jobs, d, workdir=destdir)
+        runfetchcmd("repo sync -c -l -j%s" % num_jobs, d, workdir=destdir)
 
     def download(self, ud, d):
         """Fetch url"""
@@ -76,7 +82,7 @@ class Repo(FetchMethod):
         runfetchcmd("repo init -m %s -b %s -u %s://%s%s%s" % (ud.manifest, ud.branch, ud.proto, username, ud.host, ud.path), d, workdir=ud.repodir)
 
         bb.fetch2.check_network_access(d, "repo sync %s" % ud.url, ud.url)
-        runfetchcmd("repo sync", d, workdir=ud.repodir)
+        self.sync(ud.repodir, d)
 
         scmdata = ud.parm.get("scmdata", "")
         if scmdata == "keep":
@@ -90,7 +96,7 @@ class Repo(FetchMethod):
     def unpack(self, ud, destdir, d):
         FetchMethod.unpack(self, ud, destdir, d)
         bb.fetch2.check_network_access(d, "repo sync %s" % ud.url, ud.url)
-        runfetchcmd("repo sync", d, workdir=destdir)
+        self.sync(os.path.join(destdir, "repo"), d)
 
     def supports_srcrev(self):
         return False
-- 
2.17.1

